# Title: Hydrostatic balance with solid boundaries and viscosity
#
# Description:
#
# Checks that hydrostatic balance is accurately computed when coupled
# with the Crank-Nicholson discretisation of viscous terms.
#
# Author: St\'ephane Popinet
# Command: gerris2D hydrostatic.gfs
# Version: 1.1.3
# Required files: hydrostatic.gfs
1 0 GfsSimulation GfsBox GfsGEdge {} {
    Refine 3
    Source V -1
    SourceViscosity 1e-2
    Solid (ellipse(0.,0.,0.24,0.24))
    Time { iend = 10 }
    ApproxProjectionParams { tolerance = 1e-12 }
    ProjectionParams { tolerance = 1e-12 }

    # The pressure correction needs to be included in the
    # Crank-Nicholson scheme in order to balance the body force
    AdvectionParams { gc = 1 }

    OutputScalarNorm { istep = 1 } v { v = V }
    EventScript { start = end } {
        if awk '{if ($9 > 1e-12) exit (1);}' < v ; then
            return 0;
        else
            return $GFS_STOP;
        fi
    } 
}
GfsBox {}
