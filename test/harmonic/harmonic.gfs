# Title: Poisson problem with a pure spherical harmonics solution
#
# Description:
#
# The spherical harmonics are by definition a family of functions which satisfy the
# Laplace equation on the sphere
#
# $$
#  \nabla^2 f = \frac{1}{r^2}  \frac{\partial}{\partial r}  \left( r^2 
#  \frac{\partial f}{\partial r} \right) + \frac{1}{r^2 \sin \theta} 
#  \frac{\partial}{\partial \theta}  \left( \sin \theta \frac{\partial
#  f}{\partial \theta} \right) + \frac{1}{r^2 \sin^2 \theta}  \frac{\partial^2
#  f}{\partial \varphi^2} = 0.
# $$
#
# If we look for solutions of the form $f (r, \theta, \varphi) = R (r) Y (\theta,
# \varphi)$, then two differential equations result. If we consider only the
# equation for the angles, we get
#
# $$
# \frac{1}{Y}  \frac{1}{\sin \theta}  \frac{\partial}{\partial \theta}  \left(
#  \sin \theta \frac{\partial Y}{\partial \theta} \right) + \frac{1}{Y}
#  \frac{1}{\sin^2 \theta}  \frac{\partial^2 Y}{\partial \varphi^2} = - \lambda
# $$
#
# were $\lambda$ is a constant. This equation has a whole range of solutions
# noted $Y^m_l (\theta, \varphi)$ so that
#
# $$
#  \nabla Y_l^m (\theta, \varphi) = - l (l + 1) Y_l^m (\theta, \varphi) .
# $$
#
# The $Y_l^m$ can be expressed as functions of the Legendre polynomials as
#
# $$
#  Y_l^m (\theta, \varphi) = \sqrt{\frac{2 l + 1}{4 \pi}  \frac{(l - m) !}{(l +
#  m) !}} P_l^m (\cos \theta) \cos (m \varphi)
# $$
#
# where $P_l^m$ is the associated Legendre polynomial.
#
# For this test we used $l = 4 $ and $m = 2$.
#
# \begin{figure}[htbp]
#   \caption{\label{harmonic}Solution to the Poisson problem with a pure spherical harmonic
#   solution. The analytical solution is on the left, the solution predicted by
#   Gerris is on the right.}
#   \begin{center}
#   \begin{tabular}{c}
#     \includegraphics[width=0.7\hsize]{gerris.eps}
#   \end{tabular}
#   \end{center}
# \end{figure}
#
# \begin{figure}[htbp]
#   \caption{Cross-sections of the solution of the Poisson problem for a pure
#   spherical harmonic solution for 4 different longitudes (-90, 0, 90 and
#   180).}
#   \begin{center}
#   \begin{tabular}{cc}
#     \includegraphics[width=0.45\hsize]{harmonic-profile--90-gerris.eps} &
#     \includegraphics[width=0.45\hsize]{harmonic-profile-0.eps}\\
#     -90 & 0\\
#     \includegraphics[width=0.45\hsize]{harmonic-profile-90-gerris.eps} &
#     \includegraphics[width=0.45\hsize]{harmonic-profile-180-gerris.eps}\\
#     90 & 180
#   \end{tabular}
#   \end{center}
# \end{figure}
#
#
# Author: S\'ebastien Delaux
# Command: sh harmonic.sh harmonic.gfs
# Version: 100325
# Required files: harmonic.sh gerris.gfv analytic.gfv
# Generated files: gerris.eps analytic.eps error.eps harmonic-profile--90-gerris.eps harmonic-profile-0-gerris.eps harmonic-profile-90-gerris.eps harmonic-profile-180-gerris.eps
#
6 12 GfsPoisson GfsBox GfsGEdge {} {
  Time { iend = 1 }
  PhysicalParams { L = 2.*M_PI/4. }
  MetricCubed M LEVEL
  Refine LEVEL

  GModule hypre
  ApproxProjectionParams { tolerance = 1e-30 nitermin = CYCLE nitermax = CYCLE }

  Global {
      #include <gsl/gsl_sf.h>
      @link -lgsl -lgslcblas

      double fact (double n) {
        if (n <= 1)
      	  return 1.;
    	else
	  return n*fact(n - 1.);
      }

      double legendre (int l, int m, double x) {
	  if (m < 0) 
	      return pow(-1.,fabs(m))*fact(l-fabs(m))/fact(l+fabs(m))*
	      gsl_sf_legendre_Plm (l, fabs(m), x);
	  else
	      return gsl_sf_legendre_Plm (l, m, x);
      }

      double spherical_harmonic_re (int l, int m, double X, double Y) {
	  return sqrt((2*l+1)/(4*M_PI)*fact(l-m)/fact(l+m))*
	  legendre (l, m, sin(Y/180*M_PI))*cos(m*X/180*M_PI);
      }
  }


  Init { } { 
      Div = -4*(4+1)*spherical_harmonic_re (4, 2, x, y) 
      Sol = spherical_harmonic_re (4, 2, x, y)
  }

  OutputSimulation { start = end} end-SOLVER.gfs
  OutputLocation { start = end} harmonic-profile-0.dat harmonic-profile-0
  OutputLocation { start = end} harmonic-profile-90.dat harmonic-profile-90
  OutputLocation { start = end} harmonic-profile--90.dat harmonic-profile--90
  OutputLocation { start = end} harmonic-profile-180.dat harmonic-profile-180
  OutputTime { istep = 1 } {
    awk '{if ($2 == 1) print CYCLE, $8;}' >> time
  }
  OutputProjectionStats { start = end } {
    awk '{if ($1 == "residual.infty:") print CYCLE, $3, $4;}' >> proj
  }
  OutputErrorNorm { start = end } {
    awk '{print LEVEL, $5, $7, $9}' >> error 
  } { v = P } {
    s = Sol
    unbiased = 1
  }

  EventScript { start = end } {
      gnuplot <<EOF

      set term pos enhanced eps color solid 20 lw 2
      set out 'harmonic-profile-0-SOLVER.eps'

      set xl "Latitude"
      set yl "{/Symbol F}"

      set key bottom right
      plot 'harmonic-profile-0.dat' u 3:5 ps 2 t "Gerris",\
           'harmonic-profile-0.dat'u 3:15 w l t "Analytical solution"

      set key top right
      set out 'harmonic-profile-90-SOLVER.eps'
      plot 'harmonic-profile-90.dat' u 3:5 ps 2 t "Gerris",\
           'harmonic-profile-90.dat'u 3:15 w l t "Analytical solution"

      set out 'harmonic-profile--90-SOLVER.eps'
      plot 'harmonic-profile--90.dat' u 3:5 ps 2 t "Gerris",\
           'harmonic-profile--90.dat'u 3:15 w l t "Analytical solution"

      set key bottom right
      set out 'harmonic-profile-180-SOLVER.eps'
      plot 'harmonic-profile-180.dat' u 3:5 ps 2 t "Gerris",\
           'harmonic-profile-180.dat'u 3:15 w l t "Analytical solution"
EOF
  }

}
GfsBox {}
GfsBox {}
GfsBox {}
GfsBox {}
GfsBox {}
GfsBox {}
1 2 right
2 3 top
3 4 right
4 5 top
5 6 right
6 1 top
1 3 top left
3 5 top left
5 1 top left
2 6 bottom right
4 2 bottom right
6 4 bottom right
